<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Day 2025 - Gate Scanner</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon.png') }}">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+Devanagari:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Noto Sans Devanagari', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 5px;
            font-weight: 800;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .language-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .language-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .stats-container {
            background: white;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .stat-box.entry {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .stat-box.inside {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .stat-box.exit {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 800;
            color: #333;
            display: block;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            font-weight: 600;
        }

        .scanner-section {
            background: white;
            padding: 30px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        #reader {
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .camera-status {
            text-align: center;
            padding: 60px 20px;
            background: #f8f9fa;
            border-radius: 15px;
            color: #666;
        }

        .camera-status i {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .result-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 90%;
            width: 400px;
            transition: all 0.3s ease;
        }

        .result-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .result-popup.success {
            border-top: 5px solid #10b981;
        }

        .result-popup.exit {
            border-top: 5px solid #3b82f6;
        }

        .result-popup.error {
            border-top: 5px solid #ef4444;
        }

        .result-icon {
            font-size: 64px;
            text-align: center;
            margin-bottom: 20px;
        }

        .result-icon.success {
            color: #10b981;
        }

        .result-icon.exit {
            color: #3b82f6;
        }

        .result-icon.error {
            color: #ef4444;
        }

        .result-message {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .result-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #666;
            font-weight: 600;
        }

        .detail-value {
            color: #333;
            font-weight: 700;
        }

        .close-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
        }

        .test-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .test-btn {
            flex: 1;
            padding: 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 22px;
            }

            .stat-number {
                font-size: 24px;
            }

            .result-popup {
                padding: 25px;
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <button class="language-toggle" onclick="toggleLanguage()">
        <i class="fas fa-language"></i> <span id="langToggleText">‡§π‡§ø‡§Ç‡§¶‡•Ä</span>
    </button>

    <div class="container">
        <div class="header">
            <h1 id="headerTitle">üéì Annual Day 2025</h1>
            <p id="headerSubtitle">Security Gate Scanner</p>
        </div>

        <div class="stats-container">
            <div class="stat-box entry">
                <span class="stat-number" id="entryCount">0</span>
                <span class="stat-label" id="labelEntry">Entry</span>
            </div>
            <div class="stat-box inside">
                <span class="stat-number" id="insideCount">0</span>
                <span class="stat-label" id="labelInside">Inside</span>
            </div>
            <div class="stat-box exit">
                <span class="stat-number" id="exitCount">0</span>
                <span class="stat-label" id="labelExit">Exit</span>
            </div>
        </div>

        <div class="scanner-section">
            <div id="reader"></div>
            <div id="cameraStatus" class="camera-status">
                <i class="fas fa-camera"></i>
                <p id="cameraStatusText">Initializing camera...</p>
            </div>

            <div class="test-buttons">
                <button class="test-btn" onclick="testScan()">
                    <i class="fas fa-vial"></i> <span id="btnTest">Test Scan</span>
                </button>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closePopup()"></div>

    <div class="result-popup" id="resultPopup">
        <div class="result-icon" id="resultIcon"></div>
        <div class="result-message" id="resultMessage"></div>
        <div class="result-details" id="resultDetails"></div>
        <button class="close-btn" onclick="closePopup()">
            <span id="btnClose">Close</span>
        </button>
    </div>

    <script>
        let html5QrcodeScanner;
        let currentLanguage = 'en';
        let isProcessing = false;

        const translations = {
            en: {
                headerTitle: 'üéì Annual Day 2025',
                headerSubtitle: 'Security Gate Scanner',
                labelEntry: 'Entry',
                labelInside: 'Inside',
                labelExit: 'Exit',
                btnTest: 'Test Scan',
                btnClose: 'Close',
                langToggle: '‡§π‡§ø‡§Ç‡§¶‡•Ä',
                cameraInit: 'Initializing camera...',
                cameraReady: 'Point camera at QR code',
                cameraError: 'Camera access required. Please enable camera permissions.',
                processing: 'Processing...',
                scanAgain: 'Ready to scan next'
            },
            hi: {
                headerTitle: 'üéì ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§¶‡§ø‡§µ‡§∏ 2025',
                headerSubtitle: '‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ó‡•á‡§ü ‡§∏‡•ç‡§ï‡•à‡§®‡§∞',
                labelEntry: '‡§™‡•ç‡§∞‡§µ‡•á‡§∂',
                labelInside: '‡§Ö‡§Ç‡§¶‡§∞',
                labelExit: '‡§¨‡§æ‡§π‡§∞',
                btnTest: '‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§∏‡•ç‡§ï‡•à‡§®',
                btnClose: '‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
                langToggle: 'English',
                cameraInit: '‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
                cameraReady: '‡§ï‡•à‡§Æ‡§∞‡•á ‡§ï‡•ã QR ‡§ï‡•ã‡§° ‡§™‡§∞ ‡§∞‡§ñ‡•á‡§Ç',
                cameraError: '‡§ï‡•à‡§Æ‡§∞‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡§æ‡§Ç ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§ï‡§∞‡•á‡§Ç‡•§',
                processing: '‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
                scanAgain: '‡§Ö‡§ó‡§≤‡•á ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞'
            }
        };

        function translate(key) {
            return translations[currentLanguage][key] || key;
        }

        function updateLanguage() {
            document.getElementById('headerTitle').textContent = translate('headerTitle');
            document.getElementById('headerSubtitle').textContent = translate('headerSubtitle');
            document.getElementById('labelEntry').textContent = translate('labelEntry');
            document.getElementById('labelInside').textContent = translate('labelInside');
            document.getElementById('labelExit').textContent = translate('labelExit');
            document.getElementById('btnTest').textContent = translate('btnTest');
            document.getElementById('langToggleText').textContent = translate('langToggle');
            document.getElementById('cameraStatusText').textContent = translate('cameraReady');
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'hi' : 'en';
            updateLanguage();
        }

        function startScanner() {
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrcodeScanner = new Html5Qrcode("reader");

            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    document.getElementById('cameraStatus').style.display = 'none';
                    document.getElementById('reader').style.display = 'block';

                    html5QrcodeScanner.start(
                        { facingMode: "environment" },
                        config,
                        onScanSuccess,
                        onScanFailure
                    ).catch(err => {
                        showError(translate('cameraError'));
                    });
                }
            }).catch(err => {
                showError(translate('cameraError'));
            });
        }

        function onScanSuccess(decodedText) {
            if (isProcessing) return;
            isProcessing = true;

            sendScanData(decodedText);
        }

        function onScanFailure(error) {
            // Silent - scanning continuously
        }

        function sendScanData(qrData) {
            fetch('/scan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    qr_data: qrData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showResult(data);
                } else {
                    showError(data.error || 'Scan failed');
                }

                setTimeout(() => {
                    isProcessing = false;
                }, 3000);

                updateStats();
            })
            .catch(error => {
                showError('Network error: ' + error.message);
                isProcessing = false;
            });
        }

        function showResult(data) {
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            const icon = document.getElementById('resultIcon');
            const message = document.getElementById('resultMessage');
            const details = document.getElementById('resultDetails');

            const messageText = currentLanguage === 'en' ? data.message_en : data.message_hi;

            if (data.scan_type === 'entry') {
                popup.className = 'result-popup success show';
                icon.className = 'result-icon success';
                icon.innerHTML = '<i class="fas fa-check-circle"></i>';
            } else {
                popup.className = 'result-popup exit show';
                icon.className = 'result-icon exit';
                icon.innerHTML = '<i class="fas fa-door-open"></i>';
            }

            message.textContent = messageText;

            const student = data.family.student1;
            details.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">${currentLanguage === 'en' ? 'Family ID' : '‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ID'}:</span>
                    <span class="detail-value">${data.family.family_id}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">${currentLanguage === 'en' ? 'Student' : '‡§õ‡§æ‡§§‡•ç‡§∞'}:</span>
                    <span class="detail-value">${student.name}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">${currentLanguage === 'en' ? 'Class' : '‡§ï‡§ï‡•ç‡§∑‡§æ'}:</span>
                    <span class="detail-value">${student.class}-${student.section}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">${currentLanguage === 'en' ? 'Persons' : '‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø'}:</span>
                    <span class="detail-value">${data.persons_in_family}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">${currentLanguage === 'en' ? 'Gate' : '‡§ó‡•á‡§ü'}:</span>
                    <span class="detail-value">${data.gate === '1' ? (currentLanguage === 'en' ? 'Gate 1 (Entry)' : '‡§ó‡•á‡§ü 1 (‡§™‡•ç‡§∞‡§µ‡•á‡§∂)') : (currentLanguage === 'en' ? 'Gate 2 (Exit)' : '‡§ó‡•á‡§ü 2 (‡§¨‡§æ‡§π‡§∞)')}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">${currentLanguage === 'en' ? 'Time' : '‡§∏‡§Æ‡§Ø'}:</span>
                    <span class="detail-value">${data.timestamp}</span>
                </div>
            `;

            overlay.classList.add('show');
        }

        function closePopup() {
            document.getElementById('resultPopup').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';

            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function updateStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('entryCount').textContent = data.total_entries;
                    document.getElementById('insideCount').textContent = data.current_inside;
                    document.getElementById('exitCount').textContent = data.total_exits;
                });
        }

        function testScan() {
            const testQR = {
                "family_id": "FAM-TEST-001",
                "student1": {
                    "adm_no": "A12345",
                    "name": "Test Student",
                    "class": "10",
                    "section": "A"
                },
                "parents": ["Mr. Test Parent", "Mrs. Test Parent"],
                "event": "Annual Day 2025",
                "phone": "9876543210"
            };

            sendScanData(JSON.stringify(testQR));
        }

        // Initialize
        window.onload = function() {
            updateLanguage();
            startScanner();
            updateStats();
            setInterval(updateStats, 3000);
        };
    </script>
</body>
</html>
